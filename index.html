<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digit Classifier</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0b0c10;
      --panel: #ffffff;
      --ink: #0d0d12;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-ink: #ffffff;
      --ring: rgba(37,99,235,.25);
      --ok: #16a34a;
      --warn: #b45309;
      --err: #b00020;
      --border: #e5e7eb;
      --shadow: 0 10px 24px rgba(2,8,23,.08), 0 2px 6px rgba(2,8,23,.06);
      --radius: 14px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
        --border:#1f2937; --shadow: 0 10px 30px rgba(0,0,0,.35);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink); background:linear-gradient(180deg, rgba(37,99,235,.05), transparent 30%), var(--bg);
      min-height:100svh; display:grid; place-items:center; padding:2rem;
    }
    .shell{width:min(920px, 100%); display:grid; gap:1.25rem}
    header{display:flex; align-items:center; gap:.75rem}
    .logo{
      width:40px; height:40px; display:grid; place-items:center; border-radius:10px;
      background: radial-gradient(120% 120% at 10% 10%, rgba(37,99,235,.2), transparent 70%), #111827;
      color:#9ec1ff; box-shadow: var(--shadow);
    }
    .title h1{margin:.1rem 0; font-size:1.5rem; letter-spacing:.2px}
    .title p{margin:0; color:var(--muted); font-size:.95rem}

    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow: var(--shadow); padding:1.25rem;
    }
    .grid{display:grid; gap:1rem}
    .row{display:flex; gap:.75rem; align-items:center; flex-wrap:wrap}
    .btn{
      appearance:none; border:none; border-radius:12px; padding:.8rem 1rem; font-weight:600;
      background:var(--primary); color:var(--primary-ink); cursor:pointer;
      box-shadow:0 6px 16px rgba(37,99,235,.35); transition:transform .06s ease, box-shadow .2s;
    }
    .btn[disabled]{opacity:.65; cursor:not-allowed; box-shadow:none}
    .btn:hover:not([disabled]){transform:translateY(-1px)}
    .ghost{background:transparent; color:var(--primary); border:1px solid var(--primary); box-shadow:none}

    .drop{
      border:1.5px dashed var(--border); border-radius:12px; padding:1rem; display:grid; gap:.75rem;
      align-items:center; justify-items:center; min-height:160px; text-align:center;
      outline:2px solid transparent; outline-offset:2px; transition:border-color .15s, outline-color .15s, background .15s;
      background:linear-gradient(180deg, rgba(148,163,184,.06), transparent 60%);
    }
    .drop.dragover{border-color:var(--primary); outline-color:var(--ring); background:linear-gradient(180deg, rgba(37,99,235,.06), transparent 60%)}
    .drop p{margin:0; color:var(--muted)}
    .hint{font-size:.9rem; color:var(--muted)}
    .preview{
      max-height:180px; border-radius:10px; border:1px solid var(--border); padding:.5rem; background:rgba(0,0,0,.02);
    }
    .meta{display:flex; gap:1rem; color:var(--muted); font-size:.9rem; flex-wrap:wrap}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.85rem; padding:.15rem .4rem; border:1px solid var(--border); border-radius:6px}

    .result{
      display:grid; gap:.5rem; margin-top:.5rem;
      border-top:1px dashed var(--border); padding-top:1rem;
    }
    .prediction{font-weight:700; font-size:1.1rem}
    .pill{
      display:inline-grid; grid-auto-flow:column; gap:.4rem; align-items:center; padding:.35rem .6rem;
      border-radius:999px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(148,163,184,.12), transparent 60%);
      font-size:.85rem;
    }
    .ok{color:var(--ok)} .warn{color:var(--warn)}

    .probs{display:grid; gap:.5rem}
    .bar{
      display:grid; grid-template-columns: 24px 1fr minmax(56px,auto); align-items:center; gap:.75rem;
      font-variant-numeric: tabular-nums;
    }
    .track{height:8px; border-radius:999px; background:rgba(148,163,184,.25); overflow:hidden}
    .fill{height:100%; width:0%; background:var(--primary); transition:width .5s ease}

    .toast{
      border-left:4px solid var(--err); background:rgba(176,0,32,.06);
      padding:.75rem .9rem; border-radius:10px; color:var(--ink); display:none;
    }
    .toast.show{display:block}
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .spinner{
      inline-size:18px; block-size:18px; border-radius:999px; border:2.5px solid rgba(148,163,184,.35);
      border-top-color:var(--primary); animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="logo" aria-hidden="true">
        <!-- Simple spark icon -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 2l2.2 5.3L20 9l-5.2 2.1L12 16l-2.8-4.9L4 9l5.8-1.7L12 2z" stroke="currentColor" stroke-width="1.2" fill="currentColor" opacity=".85"/>
        </svg>
      </div>
      <div class="title">
        <h1>Digit Classifier</h1>
        <p>Drag, drop, and ship insights—fast and frictionless.</p>
      </div>
    </header>

    <section class="card grid" aria-labelledby="uploader-title">
      <h2 id="uploader-title" class="sr-only">Upload</h2>

      <div id="drop" class="drop" tabindex="0" role="button" aria-label="Upload or drop an image">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 16V8m0 0-3 3m3-3 3 3M6 18h12a2 2 0 0 0 2-2v-1a4 4 0 0 0-4-4h-1.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <p><strong>Drop an image</strong> or click to browse</p>
        <p class="hint">PNG/JPEG/GIF/BMP/WebP • Max 5&nbsp;MB</p>
        <input id="imageInput" type="file" accept="image/*" class="sr-only" />
      </div>

      <div class="row">
        <button id="classifyBtn" class="btn">
          <span class="btn-label">Classify</span>
        </button>
        <button id="clearBtn" class="btn ghost" type="button">Reset</button>
        <span id="busy" class="spinner" style="display:none" aria-hidden="true"></span>
      </div>

      <div class="row">
        <img id="preview" class="preview" alt="Preview of selected image" />
        <div class="meta" id="fileMeta" aria-live="polite"></div>
      </div>

      <div id="toast" class="toast" role="alert" aria-atomic="true"></div>

      <div class="result" aria-live="polite">
        <div id="predictionResult" class="prediction"></div>
        <div id="quality" class="pill" style="display:none"></div>
        <div id="probs" class="probs" style="display:none" aria-label="Class probabilities"></div>
      </div>
    </section>
  </div>

  <script>
    // ---------- Elements ----------
    const inputEl = document.getElementById('imageInput');
    const dropEl = document.getElementById('drop');
    const btn = document.getElementById('classifyBtn');
    const clearBtn = document.getElementById('clearBtn');
    const preview = document.getElementById('preview');
    const meta = document.getElementById('fileMeta');
    const toast = document.getElementById('toast');
    const busy = document.getElementById('busy');

    const resultEl = document.getElementById('predictionResult');
    const qualityEl = document.getElementById('quality');
    const probsEl = document.getElementById('probs');

    // ---------- Config ----------
    const MAX_MB = 5;
    const ACCEPT = /^image\/(png|jpeg|gif|bmp|webp)$/;

    // ---------- Utilities ----------
    const kb = (n) => (n/1024).toFixed(0) + ' KB';
    function showToast(msg, level='error'){
      toast.textContent = msg;
      toast.classList.add('show');
      if(level==='error'){ toast.style.borderLeftColor = 'var(--err)'; }
      else if(level==='warn'){ toast.style.borderLeftColor = 'var(--warn)'; }
      else { toast.style.borderLeftColor = 'var(--ok)'; }
      setTimeout(() => toast.classList.remove('show'), 4500);
    }
    function resetUI(){
      preview.src = ''; resultEl.textContent = ''; probsEl.innerHTML = '';
      probsEl.style.display='none'; qualityEl.style.display='none';
      meta.textContent = ''; toast.classList.remove('show');
    }
    function validate(file){
      if(!file) throw new Error('Please select an image.');
      if(!ACCEPT.test(file.type)) throw new Error('Only PNG/JPEG/GIF/BMP/WebP supported.');
      if(file.size > MAX_MB*1024*1024) throw new Error(`File exceeds ${MAX_MB} MB.`);
    }
    function setBusy(on){
      busy.style.display = on ? 'inline-block' : 'none';
      btn.disabled = on;
      btn.querySelector('.btn-label').textContent = on ? 'Classifying…' : 'Classify';
    }
    function attachFile(file){
      try{
        validate(file);
        const url = URL.createObjectURL(file);
        preview.src = url;
        meta.innerHTML = `<span class="pill"><strong>File:</strong> ${file.name}</span>
                          <span class="pill">${(file.type||'image/*')}</span>
                          <span class="pill">${kb(file.size)}</span>`;
      }catch(e){ showToast(e.message); }
    }
    function renderProbs(probs){
      probsEl.innerHTML = '';
      const max = Math.max(...probs);
      probs.forEach((p, idx) => {
        const row = document.createElement('div');
        row.className = 'bar';
        const label = document.createElement('div');
        label.textContent = idx;
        const track = document.createElement('div');
        track.className = 'track';
        const fill = document.createElement('div');
        fill.className = 'fill';
        fill.style.width = (p*100).toFixed(1) + '%';
        track.appendChild(fill);
        const pct = document.createElement('div');
        pct.style.textAlign='right';
        pct.textContent = (p*100).toFixed(1) + '%';
        if (p === max) pct.style.fontWeight = '700';
        row.append(label, track, pct);
        probsEl.appendChild(row);
      });
      probsEl.style.display='grid';
    }
    function renderQuality(topP){
      qualityEl.style.display='inline-grid';
      if (topP >= 0.9){ qualityEl.className='pill ok'; qualityEl.textContent = 'High confidence'; }
      else if (topP >= 0.7){ qualityEl.className='pill'; qualityEl.textContent = 'Moderate confidence'; }
      else { qualityEl.className='pill warn'; qualityEl.textContent = 'Low confidence'; }
    }

    // ---------- DnD + Browse ----------
    dropEl.addEventListener('click', ()=> inputEl.click());
    dropEl.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); inputEl.click(); }});
    dropEl.addEventListener('dragover', (e)=>{ e.preventDefault(); dropEl.classList.add('dragover'); });
    dropEl.addEventListener('dragleave', ()=> dropEl.classList.remove('dragover'));
    dropEl.addEventListener('drop', (e)=>{
      e.preventDefault(); dropEl.classList.remove('dragover');
      const file = e.dataTransfer.files?.[0]; if(file) attachFile(file);
    });
    inputEl.addEventListener('change', ()=> {
      const file = inputEl.files?.[0]; if(file) attachFile(file);
    });
    clearBtn.addEventListener('click', ()=>{ inputEl.value=''; resetUI(); });

    // ---------- API Call ----------
    async function classify(){
      try{
        const file = inputEl.files?.[0];
        validate(file);
        setBusy(true);

        const formData = new FormData();
        formData.append('image', file, file.name || 'digit.png');

        const ctl = new AbortController();
        const t = setTimeout(() => ctl.abort(), 15000);

        const res = await fetch('/predict', { method:'POST', body:formData, signal: ctl.signal });
        clearTimeout(t);

        if(!res.ok){
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
        }

        const data = await res.json();
        if (typeof data?.prediction === 'undefined') {
          throw new Error('Malformed JSON: missing "prediction"');
        }

        const p = data.prediction;
        resultEl.textContent = `Predicted Digit: ${p}`;

        if (Array.isArray(data.probs) && data.probs.length === 10){
          const top = Math.max(...data.probs);
          renderQuality(top);
          renderProbs(data.probs);
        } else {
          qualityEl.style.display='none';
          probsEl.style.display='none';
        }
      } catch(err){
        console.error(err);
        showToast(err.name === 'AbortError' ? 'Request timeout. Please try again.' : `Request failed: ${err.message}`);
      } finally {
        setBusy(false);
      }
    }

    btn.addEventListener('click', classify);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Enter') classify(); });
  </script>
</body>
</html>

